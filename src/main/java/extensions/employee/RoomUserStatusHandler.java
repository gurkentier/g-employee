package extensions.employee;

import gearth.extensions.parsers.HEntity;
import gearth.extensions.parsers.HEntityUpdate;
import gearth.extensions.parsers.HPoint;
import gearth.protocol.HPacket;

public class RoomUserStatusHandler {

    /**
     * @param packet HPacket
     * @param roomUserList RoomUserList
     */
    public void handle(HPacket packet, RoomUserList roomUserList, HelpDeskList helpDeskList) {
        HEntityUpdate[] entityUpdates = HEntityUpdate.parse(packet);
        for (HEntityUpdate update : entityUpdates) {
            int index      = update.getIndex();
            HEntity entity = roomUserList.getEntityByIndex(index);
            if(entity != null) {
                entity.tryUpdate(update);
                HPoint tile = entity.getTile();
                System.out.println(
                         entity.getEntityType() + " " + entity.getName()
                                + " on coords: "
                                + "X " + tile.getX()
                                + " - Y " + tile.getY()
                                + " performing " + update.getAction()
                );

                this.processOccupances(entity, tile, helpDeskList);
            }
        }
    }

    /**
     * @param entity HEntity
     * @param tile HPoint
     * @param helpDeskList HelpDeskList
     */
    public void processOccupances(HEntity entity, HPoint tile, HelpDeskList helpDeskList) {
        this.removeOccupanceIfNecessary(entity, tile, helpDeskList);
        this.addOccupanceIfNeccessary(entity, tile, helpDeskList);
        helpDeskList.printHelpDesks();
    }

    /**
     * @param entity HEntity
     * @param tile HPoint
     * @param helpDeskList HelpDeskList
     */
    public void removeOccupanceIfNecessary(HEntity entity, HPoint tile, HelpDeskList helpDeskList) {
        HelpDesk desk = helpDeskList.getDeskByOwnerOccupant(entity);
        if(desk != null) {
            HPoint ownerPoint = desk.owner.point;
            if(ownerPoint.getX() != tile.getX() || ownerPoint.getY() != tile.getY()) {
                desk.owner.occupant = null;
            }
        }

        desk = helpDeskList.getDeskByTenantOccupant(entity);
        if(desk != null) {
            HPoint tenantPoint = desk.owner.point;
            if(tenantPoint.getX() != tile.getX() || tenantPoint.getY() != tile.getY()) {
                desk.tenant.occupant = null;
            }
        }
    }

    /**
     * @param entity HEntity
     * @param tile HPoint
     * @param helpDeskList HelpDeskList
     */
    public void addOccupanceIfNeccessary(HEntity entity, HPoint tile, HelpDeskList helpDeskList) {
        HelpDesk desk = helpDeskList.getDeskByOwnerPoint(tile);
        if(desk != null) {
            desk.owner.occupant = entity;
        }

        desk = helpDeskList.getDeskByTenantPoint(tile);
        if(desk != null) {
            desk.tenant.occupant = entity;
        }
    }

    /**
     * @param idx local index
     * @param roomUserList RoomUserList
     * @return HEntity
     */
    public HEntity resolveUser(int idx, RoomUserList roomUserList) {
        return roomUserList.getEntityByIndex(idx);
    }
}

/**
 [RoomUserStatus]
 Incoming[2635] <- [0][0][0]7[10]K[0][0][0][1][0][0][0][0][0][0][0][9][0][0][0][9][0][3]0.0[0][0][0][4][0][0][0][4][0][22]/flatctrl 4/sit 1.0 0/
 {l}{u:2635}{i:1}{i:0}{i:9}{i:9}{s:"0.0"}{i:4}{i:4}{s:"/flatctrl 4/sit 1.0 0/"}
 --------------------
 [RoomUserStatus]
 Incoming[2635] <- [0][0][0]9[10]K[0][0][0][1][0][0][0][0][0][0][0][9][0][0][0][9][0][3]0.0[0][0][0][0][0][0][0][0][0][24]/flatctrl 4/mv 9,8,0.0//
 {l}{u:2635}{i:1}{i:0}{i:9}{i:9}{s:"0.0"}{i:0}{i:0}{s:"/flatctrl 4/mv 9,8,0.0//"}
 --------------------
 [RoomUserStatus]
 Incoming[2635] <- [0][0][5]Ô[10]K[0][0][0])[0][0]$[153][0][0][0][8][0][0][0][14][0][3]0.0[0][0][0][4][0][0][0][4][0][25]/sit 1.600000023841858 0/[0][0]&²[0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]&ñ[0][0][0][0][0][0][0][14][0][4]0.01[0][0][0][3][0][0][0][2][0][2]//[0][0]&ï[0][0][0][0][0][0][0][14][0][4]0.01[0][0][0][3][0][0][0][2][0][2]//[0][0][0][0][0][0][0][3][0][0][0][10][0][3]0.0[0][0][0][4][0][0][0][4][0][14]mv 3,11,0.0///[0][0]&÷[0][0][0][0][0][0][0][14][0][4]0.01[0][0][0][3][0][0][0][2][0][2]//[0][0]&¨[0][0][0][25][0][0][0][17][0][3]0.0[0][0][0][6][0][0][0][6][0][2]//[0][0]$¹[0][0][0][20][0][0][0][9][0][3]0.0[0][0][0][4][0][0][0][4][0][25]/sit 1.600000023841858 0/[0][0]&û[0][0][0][0][0][0][0][14][0][4]0.01[0][0][0][3][0][0][0][2][0][2]//[0][0]&Ñ[0][0][0][14][0][0][0][15][0][3]0.0[0][0][0][4][0][0][0][4][0][2]//[0][0]%[17][0][0][0][7][0][0][0][14][0][3]0.0[0][0][0][4][0][0][0][4][0][25]/sit 1.600000023841858 0/[0][0]&Ù[0][0][0][2][0][0][0][19][0][3]0.0[0][0][0][2][0][0][0][2][0][2]//[0][0]&¿[0][0][0][10][0][0][0][10][0][3]0.0[0][0][0][6][0][0][0][6][0][11]/sit 1.0 0/[0][0]&[132][0][0][0][21][0][0][0][9][0][3]0.0[0][0][0][4][0][0][0][4][0][25]/sit 1.600000023841858 0/[0][0]&®[0][0][0][11][0][0][0][25][0][4]0.01[0][0][0][2][0][0][0][2][0][11]/sit 1.0 0/[0][0]&ö[0][0][0][20][0][0][0][18][0][3]0.0[0][0][0][5][0][0][0][4][0][2]//[0][0]"ý[0][0][0][7][0][0][0][9][0][3]0.0[0][0][0][4][0][0][0][4][0][11]/sit 1.0 0/[0][0]&É[0][0][0][2][0][0][0][26][0][6]1.0E-4[0][0][0][0][0][0][0][0][0][11]/sit 1.0 0/[0][0]&ÿ[0][0][0][10][0][0][0][17][0][4]0.45[0][0][0][3][0][0][0][2][0][2]//[0][0]&Ð[0][0][0][2][0][0][0][15][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]#Ç[0][0][0][11][0][0][0][24][0][4]0.01[0][0][0][2][0][0][0][2][0][11]/sit 1.0 0/[0][0]&Ô[0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]&î[0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]&ð[0][0][0][13][0][0][0][15][0][3]0.0[0][0][0][6][0][0][0][6][0][15]/mv 12,15,0.0//[0][0]&Ì[0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]&æ[0][0][0][5][0][0][0][11][0][4]0.01[0][0][0][2][0][0][0][2][0][26]/sit 1.2000000476837158 0/[0][0][31]Õ[0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0][28]*[0][0][0][14][0][0][0][7][0][3]0.0[0][0][0][2][0][0][0][2][0][25]/sit 3.180000066757202 0/[0][0]%[27][0][0][0][3][0][0][0][9][0][3]0.0[0][0][0][3][0][0][0][4][0][2]//[0][0][28]+[0][0][0][3][0][0][0][26][0][3]0.0[0][0][0][0][0][0][0][0][0][11]/sit 1.0 0/[0][0]&[24][0][0][0][14][0][0][0][13][0][3]0.0[0][0][0][5][0][0][0][6][0][2]//[0][0]&ü[0][0][0][17][0][0][0][16][0][3]0.0[0][0][0][5][0][0][0][6][0][2]//[0][0]&ä[0][0][0][6][0][0][0][15][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]![157][0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0][26]Â[0][0][0][8][0][0][0][19][0][3]0.0[0][0][0][4][0][0][0][4][0][11]/sit 1.0 0/[0][0]&ß[0][0][0][23][0][0][0][9][0][3]0.0[0][0][0][4][0][0][0][4][0][25]/sit 1.600000023841858 0/[0][0]%Ï[0][0][0][1][0][0][0][11][0][6]1.0E-4[0][0][0][2][0][0][0][2][0][11]/sit 1.0 0/[0][0]'[1][0][0][0][1][0][0][0][14][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//[0][0]"D[0][0][0][9][0][0][0][14][0][3]0.0[0][0][0][4][0][0][0][4][0][25]/sit 1.600000023841858 0/[0][0]'[3][0][0][0][0][0][0][0][14][0][4]0.01[0][0][0][3][0][0][0][2][0][2]//[0][0]&ý[0][0][0][3][0][0][0][16][0][3]0.0[0][0][0][3][0][0][0][2][0][2]//
 {l}{u:2635}{i:41}{i:9369}{i:8}{i:14}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.600000023841858 0/"}{i:9906}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:9969}{i:0}{i:14}{s:"0.01"}{i:3}{i:2}{s:"//"}{i:9967}{i:0}{i:14}{s:"0.01"}{i:3}{i:2}{s:"//"}{i:0}{i:3}{i:10}{s:"0.0"}{i:4}{i:4}{s:"mv 3,11,0.0///"}{i:9975}{i:0}{i:14}{s:"0.01"}{i:3}{i:2}{s:"//"}{i:9896}{i:25}{i:17}{s:"0.0"}{i:6}{i:6}{s:"//"}{i:9401}{i:20}{i:9}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.600000023841858 0/"}{i:9979}{i:0}{i:14}{s:"0.01"}{i:3}{i:2}{s:"//"}{i:9937}{i:14}{i:15}{s:"0.0"}{i:4}{i:4}{s:"//"}{i:9489}{i:7}{i:14}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.600000023841858 0/"}{i:9945}{i:2}{i:19}{s:"0.0"}{i:2}{i:2}{s:"//"}{i:9919}{i:10}{i:10}{s:"0.0"}{i:6}{i:6}{s:"/sit 1.0 0/"}{i:9860}{i:21}{i:9}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.600000023841858 0/"}{i:9902}{i:11}{i:25}{s:"0.01"}{i:2}{i:2}{s:"/sit 1.0 0/"}{i:9974}{i:20}{i:18}{s:"0.0"}{i:5}{i:4}{s:"//"}{i:8957}{i:7}{i:9}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.0 0/"}{i:9929}{i:2}{i:26}{s:"1.0E-4"}{i:0}{i:0}{s:"/sit 1.0 0/"}{i:9983}{i:10}{i:17}{s:"0.45"}{i:3}{i:2}{s:"//"}{i:9936}{i:2}{i:15}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:9159}{i:11}{i:24}{s:"0.01"}{i:2}{i:2}{s:"/sit 1.0 0/"}{i:9940}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:9966}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:9968}{i:13}{i:15}{s:"0.0"}{i:6}{i:6}{s:"/mv 12,15,0.0//"}{i:9932}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:9958}{i:5}{i:11}{s:"0.01"}{i:2}{i:2}{s:"/sit 1.2000000476837158 0/"}{i:8149}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:7210}{i:14}{i:7}{s:"0.0"}{i:2}{i:2}{s:"/sit 3.180000066757202 0/"}{i:9499}{i:3}{i:9}{s:"0.0"}{i:3}{i:4}{s:"//"}{i:7211}{i:3}{i:26}{s:"0.0"}{i:0}{i:0}{s:"/sit 1.0 0/"}{i:9752}{i:14}{i:13}{s:"0.0"}{i:5}{i:6}{s:"//"}{i:9980}{i:17}{i:16}{s:"0.0"}{i:5}{i:6}{s:"//"}{i:9956}{i:6}{i:15}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:8605}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:6850}{i:8}{i:19}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.0 0/"}{i:9951}{i:23}{i:9}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.600000023841858 0/"}{i:9679}{i:1}{i:11}{s:"1.0E-4"}{i:2}{i:2}{s:"/sit 1.0 0/"}{s:""}{b:39}{b:true}{i:1}{i:14}{s:"0.0"}{i:3}{i:2}{s:"//"}{i:8772}{i:9}{i:14}{s:"0.0"}{i:4}{i:4}{s:"/sit 1.600000023841858 0/"}{i:9987}{i:0}{i:14}{s:"0.01"}{i:3}{i:2}{s:"//"}{i:9981}{i:3}{i:16}{s:"0.0"}{i:3}{i:2}{s:"//"}
 */
